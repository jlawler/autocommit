#!/usr/bin/env ruby

$:.unshift File.expand_path File.join(File.dirname(__FILE__),'../ruby')
require 'ahp'
require 'ahp_ipc'
Thread.abort_on_exception=true
argv_cmd = ARGV.first.downcase if ARGV.size > 0
path = ARGV[1]
if ARGV.size==1
  argv_cmd=='shutdown'or AhpIpc.daemon_running? or 
    fork {AhpIpc.start_daemon!}
  if argv_cmd=='status'
    msg=''
    msg << "Auto-commit daemon running" if AhpIpc.daemon_running?
    sb = AhpIpc.read_scoreboard_file
    sb.keys.sort.each do |dir_name|v = sb[dir_name]
      time_blk = "  no autocommits"
      if lc_ts = v['last_commit']
        lc = Time.now.to_i - lc_ts
        time_blk = "last autocommit %is" % [lc]
      end
      msg << ("%40s    " % dir_name) + time_blk
    end
    puts msg
    Kernel.exit!
  end
end
if ARGV.size < 2
  STDERR.puts "Usage : ah cmd dir"
  Kernel.exit
end
unless ['shutdown','start','stop','pause','create'].include? argv_cmd
  STDERR.puts "Invalid command " + argv_cmd
  Kernel.exit
end
if path.nil? or ((path = File.expand_path(path)) and not File.exists?(path))
  STDERR.puts "path doesn't exist! #{path}"
  Kernel.exit
end

AhpIpc.write_command argv_cmd, path

